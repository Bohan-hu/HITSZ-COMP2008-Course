# 实验原理

## Cache的结构

Cache由存储体和控制机构两大主要部分构成。

### Cache的存储体

![image-20200328102752790](part2.assets/image-20200328102752790.png)

- 有效位（Valid）：标识该行内存储的数据是否有效，未装入任何数据之前无效。

- 标记（Tag）：用以唯一地标识某个地址，判断是否访问命中。

- 数据域（Data）：连续存储的k个相邻的在主存中连续的数据。

  

## 映射机制

如上所示的地址映射机制，`低2位`为字块内偏移，代表一个Cache行存储有4个字节。`中间10位`为Cache字块地址，代表Cache有1024个Cache行。`高20位`为Tag，用以唯一地标识某个主存地址，与Cache中的标记位比对，判断是否访问命中。

### 地址分解

要设计一个Cache，我们首先需要明确存储系统中主存容量、Cache的容量以及Cache的映射方式，此后进行地址的分解（Address Breakdown）。

<svg width="539" height="593" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" overflow="hidden"><defs><clipPath id="clip0"><path d="M269 65 808 65 808 658 269 658Z" fill-rule="evenodd" clip-rule="evenodd"/></clipPath></defs><g clip-path="url(#clip0)" transform="translate(-269 -65)"><path d="M599.5 517.5 806.205 517.5" stroke="#000000" stroke-width="1.33333" stroke-miterlimit="8" fill="none" fill-rule="evenodd"/><path d="M350.572 177.309 372.438 177.309 372.438 201.594 350.572 201.594Z" fill="#4472C4" fill-rule="evenodd"/><path d="M372.438 177.309 449.527 177.309 449.527 201.594 372.438 201.594Z" fill="#4472C4" fill-rule="evenodd"/><path d="M449.527 177.309 633.527 177.309 633.527 201.594 449.527 201.594Z" fill="#4472C4" fill-rule="evenodd"/><path d="M350.572 201.594 372.438 201.594 372.438 225.878 350.572 225.878Z" fill="#4472C4" fill-rule="evenodd"/><path d="M372.438 201.594 449.527 201.594 449.527 225.878 372.438 225.878Z" fill="#4472C4" fill-rule="evenodd"/><path d="M449.527 201.594 633.527 201.594 633.527 225.878 449.527 225.878Z" fill="#4472C4" fill-rule="evenodd"/><path d="M350.572 225.878 372.438 225.878 372.438 250.163 350.572 250.163Z" fill="#4472C4" fill-rule="evenodd"/><path d="M372.438 225.878 449.527 225.878 449.527 250.163 372.438 250.163Z" fill="#4472C4" fill-rule="evenodd"/><path d="M449.527 225.878 633.527 225.878 633.527 250.163 449.527 250.163Z" fill="#4472C4" fill-rule="evenodd"/><path d="M350.572 250.163 372.438 250.163 372.438 274.447 350.572 274.447Z" fill="#4472C4" fill-rule="evenodd"/><path d="M372.438 250.163 449.527 250.163 449.527 274.447 372.438 274.447Z" fill="#4472C4" fill-rule="evenodd"/><path d="M449.527 250.163 633.527 250.163 633.527 274.447 449.527 274.447Z" fill="#4472C4" fill-rule="evenodd"/><path d="M350.572 274.447 372.438 274.447 372.438 298.732 350.572 298.732Z" fill="#ED7D31" fill-rule="evenodd"/><path d="M372.438 274.447 449.527 274.447 449.527 298.732 372.438 298.732Z" fill="#ED7D31" fill-rule="evenodd"/><path d="M449.527 274.447 633.527 274.447 633.527 298.732 449.527 298.732Z" fill="#ED7D31" fill-rule="evenodd"/><path d="M350.572 298.732 372.438 298.732 372.438 323.016 350.572 323.016Z" fill="#4472C4" fill-rule="evenodd"/><path d="M372.438 298.732 449.527 298.732 449.527 323.016 372.438 323.016Z" fill="#4472C4" fill-rule="evenodd"/><path d="M449.527 298.732 633.527 298.732 633.527 323.016 449.527 323.016Z" fill="#4472C4" fill-rule="evenodd"/><path d="M350.572 323.016 372.438 323.016 372.438 347.3 350.572 347.3Z" fill="#4472C4" fill-rule="evenodd"/><path d="M372.438 323.016 449.527 323.016 449.527 347.3 372.438 347.3Z" fill="#4472C4" fill-rule="evenodd"/><path d="M449.527 323.016 633.527 323.016 633.527 347.3 449.527 347.3Z" fill="#4472C4" fill-rule="evenodd"/><path d="M350.572 347.3 372.438 347.3 372.438 371.585 350.572 371.585Z" fill="#4472C4" fill-rule="evenodd"/><path d="M372.438 347.3 449.527 347.3 449.527 371.585 372.438 371.585Z" fill="#4472C4" fill-rule="evenodd"/><path d="M449.527 347.3 633.527 347.3 633.527 371.585 449.527 371.585Z" fill="#4472C4" fill-rule="evenodd"/><path d="M350.572 371.585 372.438 371.585 372.438 395.869 350.572 395.869Z" fill="#4472C4" fill-rule="evenodd"/><path d="M372.438 371.585 449.527 371.585 449.527 395.869 372.438 395.869Z" fill="#4472C4" fill-rule="evenodd"/><path d="M449.527 371.585 633.527 371.585 633.527 395.869 449.527 395.869Z" fill="#4472C4" fill-rule="evenodd"/><path d="M350.572 395.869 372.438 395.869 372.438 420.154 350.572 420.154Z" fill="#4472C4" fill-rule="evenodd"/><path d="M372.438 395.869 449.527 395.869 449.527 420.154 372.438 420.154Z" fill="#4472C4" fill-rule="evenodd"/><path d="M449.527 395.869 633.527 395.869 633.527 420.154 449.527 420.154Z" fill="#4472C4" fill-rule="evenodd"/><path d="M372.438 176.643 372.438 420.82" stroke="#000000" stroke-width="1.33333" stroke-linejoin="round" stroke-miterlimit="10" fill="none" fill-rule="evenodd"/><path d="M449.527 176.643 449.527 420.82" stroke="#000000" stroke-width="1.33333" stroke-linejoin="round" stroke-miterlimit="10" fill="none" fill-rule="evenodd"/><path d="M349.905 201.594 634.193 201.594" stroke="#000000" stroke-width="1.33333" stroke-linejoin="round" stroke-miterlimit="10" fill="none" fill-rule="evenodd"/><path d="M349.905 225.878 634.193 225.878" stroke="#000000" stroke-width="1.33333" stroke-linejoin="round" stroke-miterlimit="10" fill="none" fill-rule="evenodd"/><path d="M349.905 250.163 634.193 250.163" stroke="#000000" stroke-width="1.33333" stroke-linejoin="round" stroke-miterlimit="10" fill="none" fill-rule="evenodd"/><path d="M349.905 274.447 634.193 274.447" stroke="#000000" stroke-width="1.33333" stroke-linejoin="round" stroke-miterlimit="10" fill="none" fill-rule="evenodd"/><path d="M349.905 298.732 634.193 298.732" stroke="#000000" stroke-width="1.33333" stroke-linejoin="round" stroke-miterlimit="10" fill="none" fill-rule="evenodd"/><path d="M349.905 323.016 634.193 323.016" stroke="#000000" stroke-width="1.33333" stroke-linejoin="round" stroke-miterlimit="10" fill="none" fill-rule="evenodd"/><path d="M349.905 347.3 634.193 347.3" stroke="#000000" stroke-width="1.33333" stroke-linejoin="round" stroke-miterlimit="10" fill="none" fill-rule="evenodd"/><path d="M349.905 371.585 634.193 371.585" stroke="#000000" stroke-width="1.33333" stroke-linejoin="round" stroke-miterlimit="10" fill="none" fill-rule="evenodd"/><path d="M349.905 395.869 634.193 395.869" stroke="#000000" stroke-width="1.33333" stroke-linejoin="round" stroke-miterlimit="10" fill="none" fill-rule="evenodd"/><path d="M350.572 176.643 350.572 420.82" stroke="#000000" stroke-width="1.33333" stroke-linejoin="round" stroke-miterlimit="10" fill="none" fill-rule="evenodd"/><path d="M633.527 176.643 633.527 420.82" stroke="#000000" stroke-width="1.33333" stroke-linejoin="round" stroke-miterlimit="10" fill="none" fill-rule="evenodd"/><path d="M349.905 177.309 634.193 177.309" stroke="#000000" stroke-width="1.33333" stroke-linejoin="round" stroke-miterlimit="10" fill="none" fill-rule="evenodd"/><path d="M349.905 420.154 634.193 420.154" stroke="#000000" stroke-width="1.33333" stroke-linejoin="round" stroke-miterlimit="10" fill="none" fill-rule="evenodd"/><path d="M344.193 66.2875 494.326 66.2875 494.326 114.287 344.193 114.287Z" fill="#D0CECE" fill-rule="evenodd"/><path d="M494.326 66.2875 574.326 66.2875 574.326 114.287 494.326 114.287Z" fill="#D0CECE" fill-rule="evenodd"/><path d="M574.326 66.2875 633.526 66.2875 633.526 114.287 574.326 114.287Z" fill="#D0CECE" fill-rule="evenodd"/><path d="M494.326 65.6208 494.326 114.954" stroke="#000000" stroke-width="1.33333" stroke-linejoin="round" stroke-miterlimit="10" fill="none" fill-rule="evenodd"/><path d="M574.326 65.6208 574.326 114.954" stroke="#000000" stroke-width="1.33333" stroke-linejoin="round" stroke-miterlimit="10" fill="none" fill-rule="evenodd"/><path d="M344.193 65.6208 344.193 114.954" stroke="#000000" stroke-width="1.33333" stroke-linejoin="round" stroke-miterlimit="10" fill="none" fill-rule="evenodd"/><path d="M633.526 65.6208 633.526 114.954" stroke="#000000" stroke-width="1.33333" stroke-linejoin="round" stroke-miterlimit="10" fill="none" fill-rule="evenodd"/><path d="M343.527 66.2875 634.193 66.2875" stroke="#000000" stroke-width="1.33333" stroke-linejoin="round" stroke-miterlimit="10" fill="none" fill-rule="evenodd"/><path d="M343.527 114.287 634.193 114.287" stroke="#000000" stroke-width="1.33333" stroke-linejoin="round" stroke-miterlimit="10" fill="none" fill-rule="evenodd"/><text font-family="DengXian,DengXian_MSFontService,sans-serif" font-weight="700" font-size="16" transform="translate(395.26 96)">标记位<tspan x="117.233" y="-10">Cache</tspan><tspan x="123.067" y="9">索引</tspan><tspan x="192.667" y="-10">字节</tspan><tspan x="192.667" y="9">偏移</tspan></text><path d="M271.5 147.5 271.5 518.505" stroke="#000000" stroke-width="1.33333" stroke-miterlimit="8" fill="none" fill-rule="evenodd"/><path d="M419.5 114.5 419.5 150.157" stroke="#000000" stroke-width="1.33333" stroke-miterlimit="8" fill="none" fill-rule="evenodd"/><path d="M660.5 148.5 660.5 197.719" stroke="#000000" stroke-width="1.33333" stroke-miterlimit="8" fill="none" fill-rule="evenodd"/><path d="M733.5 287.5 733.5 438.833" stroke="#000000" stroke-width="1.33333" stroke-miterlimit="8" fill="none" fill-rule="evenodd"/><path d="M0 0 245 0 231.917 21 20.2615 20.1915C13.4995 13.461 6.762 6.7305 0 0Z" stroke="#2F528F" stroke-width="1.33333" stroke-miterlimit="8" fill="#FFFFFF" fill-rule="evenodd" transform="matrix(-4.37114e-08 1 1 4.37114e-08 649.5 175.5)"/><text font-family="DengXian,DengXian_MSFontService,sans-serif" font-weight="300" font-size="14" transform="matrix(-1.83697e-16 -1 1 -1.83697e-16 664.127 312)">MUX</text><path d="M350.572 465.825 372.438 465.825 372.438 490.109 350.572 490.109Z" fill="#F4B183" fill-rule="evenodd"/><path d="M372.438 465.825 449.527 465.825 449.527 490.109 372.438 490.109Z" fill="#FFC000" fill-rule="evenodd"/><path d="M449.527 465.825 495.527 465.825 495.527 490.109 449.527 490.109Z" fill="#E7E6E6" fill-rule="evenodd"/><path d="M495.527 465.825 541.527 465.825 541.527 490.109 495.527 490.109Z" fill="#E7E6E6" fill-rule="evenodd"/><path d="M541.527 465.825 587.527 465.825 587.527 490.109 541.527 490.109Z" fill="#E7E6E6" fill-rule="evenodd"/><path d="M587.527 465.825 633.527 465.825 633.527 490.109 587.527 490.109Z" fill="#E7E6E6" fill-rule="evenodd"/><path d="M372.438 465.158 372.438 490.776" stroke="#000000" stroke-width="1.33333" stroke-linejoin="round" stroke-miterlimit="10" fill="none" fill-rule="evenodd"/><path d="M449.527 465.158 449.527 490.776" stroke="#000000" stroke-width="1.33333" stroke-linejoin="round" stroke-miterlimit="10" fill="none" fill-rule="evenodd"/><path d="M495.527 465.158 495.527 490.776" stroke="#000000" stroke-width="1.33333" stroke-linejoin="round" stroke-miterlimit="10" fill="none" fill-rule="evenodd"/><path d="M541.527 465.158 541.527 490.776" stroke="#000000" stroke-width="1.33333" stroke-linejoin="round" stroke-miterlimit="10" fill="none" fill-rule="evenodd"/><path d="M587.527 465.158 587.527 490.776" stroke="#000000" stroke-width="1.33333" stroke-linejoin="round" stroke-miterlimit="10" fill="none" fill-rule="evenodd"/><path d="M350.572 465.158 350.572 490.776" stroke="#000000" stroke-width="1.33333" stroke-linejoin="round" stroke-miterlimit="10" fill="none" fill-rule="evenodd"/><path d="M633.527 465.158 633.527 490.776" stroke="#000000" stroke-width="1.33333" stroke-linejoin="round" stroke-miterlimit="10" fill="none" fill-rule="evenodd"/><path d="M349.905 465.825 634.193 465.825" stroke="#000000" stroke-width="1.33333" stroke-linejoin="round" stroke-miterlimit="10" fill="none" fill-rule="evenodd"/><path d="M349.905 490.109 634.193 490.109" stroke="#000000" stroke-width="1.33333" stroke-linejoin="round" stroke-miterlimit="10" fill="none" fill-rule="evenodd"/><text font-family="DengXian,DengXian_MSFontService,sans-serif" font-weight="400" font-size="9" transform="translate(358.672 480)">V<tspan x="43.7274" y="0">TAG</tspan><tspan x="101.938" y="0">Data3</tspan><tspan x="147.938" y="0">Data2</tspan><tspan x="193.938" y="0">Data1</tspan><tspan x="239.938" y="0">Data0</tspan></text><path d="M0 0 186 0 176.068 21 15.3822 20.1915C10.2486 13.461 5.1336 6.7305 0 0Z" stroke="#2F528F" stroke-width="1.33333" stroke-miterlimit="8" fill="#FFFFFF" fill-rule="evenodd" transform="matrix(-1 -8.74228e-08 -8.74228e-08 1 634.5 503.5)"/><text font-family="DengXian,DengXian_MSFontService,sans-serif" font-weight="300" font-size="16" transform="translate(524.593 519)">MUX</text><path d="M395.5 518.5C395.5 509.664 402.664 502.5 411.5 502.5 420.337 502.5 427.5 509.664 427.5 518.5 427.5 527.337 420.337 534.5 411.5 534.5 402.664 534.5 395.5 527.337 395.5 518.5Z" stroke="#000000" stroke-width="1.33333" stroke-miterlimit="8" fill="#FFFFFF" fill-rule="evenodd"/><text font-family="DengXian,DengXian_MSFontService,sans-serif" font-weight="300" font-size="24" transform="translate(403.293 525)">=</text><path d="M475.5 490.5 475.5 503.836" stroke="#000000" stroke-width="1.33333" stroke-miterlimit="8" fill="none" fill-rule="evenodd"/><path d="M520.5 490.5 520.5 503.836" stroke="#000000" stroke-width="1.33333" stroke-miterlimit="8" fill="none" fill-rule="evenodd"/><path d="M565.5 490.5 565.5 503.836" stroke="#000000" stroke-width="1.33333" stroke-miterlimit="8" fill="none" fill-rule="evenodd"/><path d="M610.5 490.5 610.5 503.836" stroke="#000000" stroke-width="1.33333" stroke-miterlimit="8" fill="none" fill-rule="evenodd"/><path d="M411.5 490.5 411.5 502.347" stroke="#000000" stroke-width="1.33333" stroke-miterlimit="8" fill="none" fill-rule="evenodd"/><path d="M362.5 491.5 362.5 564.401" stroke="#000000" stroke-width="1.33333" stroke-miterlimit="8" fill="none" fill-rule="evenodd"/><path d="M386.5 564.5 386.5 579.5C386.5 587.784 380.232 594.5 372.5 594.5 364.768 594.5 358.5 587.784 358.5 579.5L358.5 564.5Z" stroke="#2F528F" stroke-width="1.33333" stroke-miterlimit="8" fill="#FFFFFF" fill-rule="evenodd"/><path d="M634.5 189.5 650.1 189.5" stroke="#000000" stroke-width="1.33333" stroke-miterlimit="8" fill="none" fill-rule="evenodd"/><path d="M634.5 214.5 650.1 214.5" stroke="#000000" stroke-width="1.33333" stroke-miterlimit="8" fill="none" fill-rule="evenodd"/><path d="M634.5 240.5 650.1 240.5" stroke="#000000" stroke-width="1.33333" stroke-miterlimit="8" fill="none" fill-rule="evenodd"/><path d="M634.5 264.5 650.1 264.5" stroke="#000000" stroke-width="1.33333" stroke-miterlimit="8" fill="none" fill-rule="evenodd"/><path d="M634.5 287.5 650.1 287.5" stroke="#000000" stroke-width="1.33333" stroke-miterlimit="8" fill="none" fill-rule="evenodd"/><path d="M634.5 310.5 650.1 310.5" stroke="#000000" stroke-width="1.33333" stroke-miterlimit="8" fill="none" fill-rule="evenodd"/><path d="M634.5 335.5 650.1 335.5" stroke="#000000" stroke-width="1.33333" stroke-miterlimit="8" fill="none" fill-rule="evenodd"/><path d="M634.5 360.5 650.1 360.5" stroke="#000000" stroke-width="1.33333" stroke-miterlimit="8" fill="none" fill-rule="evenodd"/><path d="M634.5 383.5 650.1 383.5" stroke="#000000" stroke-width="1.33333" stroke-miterlimit="8" fill="none" fill-rule="evenodd"/><path d="M634.5 406.5 650.1 406.5" stroke="#000000" stroke-width="1.33333" stroke-miterlimit="8" fill="none" fill-rule="evenodd"/><path d="M670.5 287.5 733.833 287.5" stroke="#000000" stroke-width="1.33333" stroke-miterlimit="8" fill="none" fill-rule="evenodd"/><path d="M362.5 439.5 733.617 439.5" stroke="#000000" stroke-width="1.33333" stroke-miterlimit="8" fill="none" fill-rule="evenodd"/><path d="M362.5 438.5 362.5 466.037" stroke="#000000" stroke-width="1.33333" stroke-miterlimit="8" fill="none" fill-rule="evenodd"/><path d="M411.5 439.5 411.5 467.037" stroke="#000000" stroke-width="1.33333" stroke-miterlimit="8" fill="none" fill-rule="evenodd"/><path d="M474.5 439.5 474.5 467.037" stroke="#000000" stroke-width="1.33333" stroke-miterlimit="8" fill="none" fill-rule="evenodd"/><path d="M524.5 439.5 524.5 467.037" stroke="#000000" stroke-width="1.33333" stroke-miterlimit="8" fill="none" fill-rule="evenodd"/><path d="M565.5 439.5 565.5 467.037" stroke="#000000" stroke-width="1.33333" stroke-miterlimit="8" fill="none" fill-rule="evenodd"/><path d="M610.5 439.5 610.5 467.037" stroke="#000000" stroke-width="1.33333" stroke-miterlimit="8" fill="none" fill-rule="evenodd"/><path d="M271.5 518.5 395.945 518.5" stroke="#000000" stroke-width="1.33333" stroke-miterlimit="8" fill="none" fill-rule="evenodd"/><path d="M271.5 150.5 421.983 150.5" stroke="#000000" stroke-width="1.33333" stroke-miterlimit="8" fill="none" fill-rule="evenodd"/><path d="M539.5 114.5 539.5 147.052" stroke="#000000" stroke-width="1.33333" stroke-miterlimit="8" fill="none" fill-rule="evenodd"/><path d="M540.5 147.5 660.5 147.5" stroke="#000000" stroke-width="1.33333" stroke-miterlimit="8" fill="none" fill-rule="evenodd"/><path d="M634.5 90.5001 807.567 90.5002" stroke="#000000" stroke-width="1.33333" stroke-miterlimit="8" fill="none" fill-rule="evenodd"/><path d="M807.5 90.5001 807.5 518.057" stroke="#000000" stroke-width="1.33333" stroke-miterlimit="8" fill="none" fill-rule="evenodd"/><path d="M542.5 523.5 542.5 618.975" stroke="#000000" stroke-width="1.33333" stroke-miterlimit="8" fill="none" fill-rule="evenodd"/><path d="M412.5 534.5 412.5 550.677" stroke="#000000" stroke-width="1.33333" stroke-miterlimit="8" fill="none" fill-rule="evenodd"/><path d="M375.5 548.5 375.5 564.677" stroke="#000000" stroke-width="1.33333" stroke-miterlimit="8" fill="none" fill-rule="evenodd"/><path d="M374.5 548.5 411.476 548.5" stroke="#000000" stroke-width="1.33333" stroke-miterlimit="8" fill="none" fill-rule="evenodd"/><path d="M372.5 594.5 372.5 618.779" stroke="#000000" stroke-width="1.33333" stroke-miterlimit="8" fill="none" fill-rule="evenodd"/><rect x="348.5" y="619.5" width="45" height="32" stroke="#000000" stroke-width="1.33333" stroke-linejoin="round" stroke-miterlimit="10" fill="#8FAADC"/><text font-family="DengXian,DengXian_MSFontService,sans-serif" font-weight="300" font-size="19" transform="translate(357.773 641)">hit<tspan x="19.3333" y="0">? </tspan></text><rect x="514.5" y="618.5" width="56" height="32" stroke="#000000" stroke-width="1.33333" stroke-linejoin="round" stroke-miterlimit="10" fill="#00B0F0"/><text font-family="DengXian,DengXian_MSFontService,sans-serif" font-weight="300" font-size="19" transform="translate(524.082 640)">data</text></g></svg>

例如，我们系统的主存容量为256KB，则主存地址宽度为18位；我们设计Cache每个字块中存储4个字节，则每个块中需要用2位去寻址相应的字节；Cache容量为256行（256*4B=1024B），且设计的方式是直接相联，则Cache字块地址为8位；剩余的18-8-2=8位，则作为Tag使用。此时，我们即完成了地址的分解工作。

如上图所示，一个典型的直接映射Cache访问主要完成几项工作：

- Cache寻址：根据主存地址中的Cache索引，选出对应的Cache块（行）
- 标记比对：主存中的标记位和取出行中的标记位对比，加上Valid位，判断是否命中
- 选出数据：如果命中，根据地址的低位偏移，在读出的Cache Line的数据域中，选择相应的数据，回送给主设备，并采取相应的机制通知主设备，在本次实验中，我们要求拉高Cache模块的`hit`信号，同时将数据输出到`data_out`上。
- 缺失处理：如果不命中的话，还需要进行缺失的处理，在下一部分将会提到。

> 下面是一次Cache访问的实例：
>
> 访问地址`0x7c00685d`
>
> 转换为二进制为`0111 1100 0000 0000 0110 1000 0101 1101`
>
> 我们看到，Tag部分为`01111100000000000110`，Cache索引为`1000010111`，则将访问Cache的第535行，取出第535行后，将判断其`Valid`域是否为1，并且Tag部分是否相等，如果相等，则取出4个字节中，偏移为1的字节。

## 缺失处理机制

当Cache的访问发生缺失时，应要有相应的机制，确定缺失的位置，并向下一级存储器发出读字块的请求。

### 缺失动作

在缺失时，Cache向下一级存储器（本实验中为`mem_wrap`）发起读请求，请求读取4个连续存储的字，待下级存储器响应后，将返回的数据采集、打上相应的标签，然后写入自身的存储体中。

### 实现原理

在时序电路中，如果要执行顺序发生的动作，并带有条件跳转，状态机是通用的做法。我们使用状态机生成控制信号，对数据通路进行操纵，从而达到处理各种情况的目的。

下面，我们给出两种状态机实现的例子。Moore状态机状态较多，Mealy状态机控制较为灵活，实现较为简单，大家可以自由选择。

#### Moore状态机实现

由上面的描述，我们可以总结出Cache具有五个状态：

- `READY`：Cache处在就绪状态，可以接受访问请求，一旦有访问请求，接受访问地址，下一周期即可转到`TAG_CHECK`状态，相应的Cache行将被读出

- `TAG_CHECK`：在这一阶段，Cache对读出的Cache行进行标签和有效性的检查
    - 如果命中，则转移到`HIT`状态，输出相应的数据，并拉高`hit`信号。
    - 如果未命中，则需要进行重填，进入`WAIT_MEM`状态

- `HIT`：Cache访问命中，将数据输出一周期后，返回`READY`状态，准备接受下一个输入。

- `WAIT_MEM`：在这一阶段，Cache对主存模块发起访问请求，等待主存相应的连续字块传输回来，直到主存通知字块传输完成，转入`REFILL`状态。

- `REFILL`：此时，将取回的字块，加上相应的标签，存进自己的存储体内，此后，返回到`TAG_CHECK`状态。

#### Mealy状态机实现

- `READY`：Cache处在就绪状态，可以接受访问请求，一旦有访问请求，接受访问地址，下一周期即可转到`TAG_CHECK`状态，相应的Cache行将被读出

- `TAG_CHECK`：在这一阶段，Cache对读出的Cache行进行标签和有效性的检查
    - 如果命中，则输出相应的数据，并拉高`hit`信号。
    - 如果未命中，则需要进行重填，进入`REFILL`状态

- `REFILL`：在这一阶段，Cache对主存模块发起访问请求，等待主存相应的连续字块传输回来，直到主存通知字块传输完成，此时，将取回的字块，加上相应的标签，存进自己的存储体内，此后，返回到`TAG_CHECK`状态。